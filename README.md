# lateimport

Lazy import utilities for Python — defer module loading until an imported object is actually used.

[![PyPI](https://img.shields.io/pypi/v/lateimport)](https://pypi.org/project/lateimport/)
[![Python](https://img.shields.io/pypi/pyversions/lateimport)](https://pypi.org/project/lateimport/)
[![License](https://img.shields.io/badge/license-MIT%20OR%20Apache--2.0-blue)](LICENSE-MIT)

## Overview

`lateimport` provides two complementary tools:

- **`lazy_import`** — an explicit proxy for deferring imports in application code
- **`create_lazy_getattr`** — a factory for the `__getattr__` hook in package `__init__.py` files, for use with dispatch-table-based lazy loading (e.g. as generated by [Exportify](https://github.com/knitli/exportify))

Both are stdlib-only. No dependencies.

## Requirements

Python 3.12+

## Installation

```bash
pip install lateimport
```

## Usage

### Explicit lazy imports

Use `lazy_import` when you want to defer a heavy import in application code. The module is not imported until the returned proxy is actually *used* — called, subscripted, passed to `isinstance`, etc.

```python
from lateimport import lazy_import

# No import happens here
numpy = lazy_import("numpy")
pandas = lazy_import("pandas", "DataFrame")  # defers pandas.DataFrame

# Import triggered on first use
result = numpy.array([1, 2, 3])
df = pandas({"a": [1, 2]})
```

Proxies are thread-safe and cache the resolved object after first access.

```python
proxy = lazy_import("heavy.module", "ExpensiveClass")

proxy.is_resolved()   # False
instance = proxy()    # heavy.module imported, ExpensiveClass resolved
proxy.is_resolved()   # True
```

### Package-level lazy `__getattr__`

For packages using a dispatch-table pattern (e.g. generated by Exportify), `create_lazy_getattr` creates a `__getattr__` hook that imports attributes on demand:

```python
# mypackage/__init__.py
from types import MappingProxyType
from lateimport import create_lazy_getattr

_dynamic_imports = MappingProxyType({
    "MyClass":      ("mypackage.core",   "models"),
    "my_function":  ("mypackage.utils",  "helpers"),
    "SubModule":    ("mypackage",        "__module__"),
})

__getattr__ = create_lazy_getattr(_dynamic_imports, globals(), __name__)

__all__ = ("MyClass", "my_function", "SubModule")
```

The dispatch tuple is `(package, submodule)`:
- **Normal attributes**: imports `package.submodule` and returns `getattr(submodule, attr_name)`
- **`"__module__"`**: imports the submodule itself as the attribute (`import_module(f".{attr_name}", package=package)`)

Resolved attributes are cached in `globals()` so subsequent accesses are direct.

## API

### `lazy_import(module_name, *attrs) -> LazyImport`

Create a lazy proxy for `module_name`. Optional `attrs` are an attribute chain traversed after import.

```python
lazy_import("os")                    # proxy for the os module
lazy_import("os.path", "join")       # proxy for os.path.join
lazy_import("mypackage", "A", "B")   # proxy for mypackage.A.B
```

### `class LazyImport`

The proxy class returned by `lazy_import`. Supports call, attribute access, `dir()`, and `repr()`. Thread-safe.

| Method | Description |
|--------|-------------|
| `is_resolved()` | `True` if the import has been triggered |
| `_resolve()` | Force immediate resolution and return the object |

### `create_lazy_getattr(dynamic_imports, module_globals, module_name)`

Create a `__getattr__` function for package-level lazy loading.

| Parameter | Type | Description |
|-----------|------|-------------|
| `dynamic_imports` | `MappingProxyType[str, tuple[str, str]]` | Dispatch table |
| `module_globals` | `dict[str, object]` | `globals()` of the calling module |
| `module_name` | `str` | `__name__` of the calling module |

### `INTROSPECTION_ATTRIBUTES`

`frozenset` of dunder attribute names that are resolved immediately rather than proxied (e.g. `__doc__`, `__name__`, `__module__`). Available for reference when implementing custom proxy patterns.

## License

`MIT OR Apache-2.0` — see [LICENSE-MIT](LICENSE-MIT) and [LICENSE-Apache-2.0](LICENSE-Apache-2.0).
